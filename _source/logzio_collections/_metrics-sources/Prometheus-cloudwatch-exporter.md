# logzio-aws-metrics
**IMPORTANT ⚠️ :** This project should be used by selected beta customers only

This project allows you to collect Prometheus format metrics from Cloudwatch with cloudwatch exporter, and ship them to logz.io using Opentelemtry collector.

### Schema
![image info]()
### Collect cloudwatch metrics
This docker compose file uses containers with the following images:
* [otel/opentelemetry-collector](https://hub.docker.com/r/otel/opentelemetry-collector)
* [prom/cloudwatch-exporter](https://hub.docker.com/r/prom/cloudwatch-exporter)
* [logzio/config-builder]()

#### How to use:
* Download the `docker-compose.yml` file
```
curl https://raw.githubusercontent.com/logzio/logzio-aws-metrics/main/docker-compose.yml -o docker-compose.yml
```
* Define environment variables and run `docker-compose up`
```
LOGZIO_MODULES="aws" \
AWS_ACCESS_KEY_ID=<<AWS_ACCESS_KEY_ID>> \
AWS_SECRET_ACCESS_KEY=<<AWS_SECRET_ACCESS_KEY>> \
AWS_DEFAULT_REGION=<<AWS_DEFAULT_REGION>> \
LOGZIO_REGION= <<LOGZIO_REGION>> \
LOGZIO_TOKEN=<<LOGZIO_TOKEN>> \
AWS_NAMESPACES=<<AWS_NAMESPACES>> \
SCRAPE_INTERVAL=<<SCRAPE_INTERVAL>> \
P8S_LOGZIO_NAME=<<P8S_LOGZIO_NAME>> \
docker-compose up
```

You'll also need to set up an IAM user
with the permissions to fetch the right metrics.

**Note:** Extra calls and charges on AWS API requests may be generated by this project. You can track the number of AWS API requests with the `cloudwatch_requests_total` metric, which provides labels with the API name and namespace specification. For example : 

`cloudwatch_requests_total{action="getMetricStatistics",namespace="AWS/EC2",} 876.0`).

For more information about the prom/cloudwatch-exporter cost, refer to the relevant Prometheus [documentation](https://github.com/prometheus/cloudwatch_exporter#cost) and to the [AWS cloudwatch api pricing](https://aws.amazon.com/cloudwatch/pricing/).

### Configuration
#### Environment variable for `logzio/config-builder` container
| Environment variable | Description |
|---|---|
| AWS_DEFAULT_REGION (Required) | Your region's slug. You can find this in the AWS Console region menu (in the top menu, to the right).<br> **Note:** This is the region that you will collect metrics from. |
| LOGZIO_REGION (Required)| Your Logz.io region code. For example if your region is US, then your region code is `us`. You can find your region code here: https://docs.logz.io/user-guide/accounts/account-region.html#regions-and-urls for further information. |
| LOGZIO_MODULES (Required)| Comma-separated list of modules to be enabled on this container (formatted as "module1,module2,module3"). |
| LOGZIO_TOKEN (Required)| Token for shipping metrics to your Logz.io account. Find it under Settings -> Manage accounts.
 |
| SCRAPE_INTERVAL (Required)| The time interval (in seconds) during which the Cloudwatch exporter retrieves metrics from Cloudwatch, and the Opentelemtry collector scrapes and sends the metrics to Logz.io. Default = 300 <br> **Note:** This value must be a multiple of 60.|
| AWS_NAMESPACES (Required) | Comma-separated list of namespaces of the metrics you want to collect. <br> You can find a complete list of namespaces at [_AWS Services That Publish CloudWatch Metrics_](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/aws-services-cloudwatch-metrics.html) <br> **Note:** This Environment variable is required unless you define the `CUSTOM_CONFIG_PATH` Environment variable |
| P8S_LOGZIO_NAME | The value of the `p8s_logzio_name` external label. This variable identifies which Prometheus environment the metrics arriving at Logz.io came from. Default = `logzio-cloudwatch-metrics`.  |
| CUSTOM_CONFIG_PATH | Path to your Cloudwatch exporter configuration file. For more information refer to the [documentation](https://github.com/prometheus/cloudwatch_exporter#configuration). <br> **Note:** Set the `period_seconds` parameter according to your `SCRAPE_INTERVAL`|
| CUSTOM_LISTENER | Set a custom URL to ship metrics to (e.g., http://localhost:9200). This overrides the `LOGZIO_REGION` Environment variable |

#### Environment variables for `prom/cloudwatch-exporter` container
| Environment variable | Description |
|---|---|
| AWS_ACCESS_KEY_ID (Required)| Your IAM user's access key ID. |
| AWS_SECRET_ACCESS_KEY (Required)| Your IAM user's secret key. |

#### View services configuration
You can view the configuration in the browser
* Opentelemtry collector: http://localhost:5001/config/otel
* Cloudwatch exporter: http://localhost:5001/config/cloudwatch
#### Help with region configuration

You'll need to specify the AWS region you're collecting metrics from.

![AWS region menu](https://dytvr9ot2sszz.cloudfront.net/logz-docs/aws/region-menu.png)

Find your region's slug in the region menu
(in the top menu, on the right side).

For example:
The slug for US East (N. Virginia)
is "us-east-1",
and the slug for Canada (Central) is "ca-central-1".


